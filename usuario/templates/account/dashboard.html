{% extends "base.html" %} {# Asegúrate de que tu base.html carga Bootstrap #}
{% load static %} {# Asegúrate de cargar static para tus CSS #}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <div class="container-fluid mt-3">
        <div class="row">
            {# Columna del Sidebar (30%) #}
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#" id="dashboard-link">
                                <span data-feather="home"></span>
                                Inicio
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="reportes-link">
                                <span data-feather="reportes"></span>
                                Reportes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="estadisticas-link">
                                <span data-feather="estadisticas"></span>
                                Estadísticas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="settings-link">
                                <span data-feather="settings"></span>
                                Configuración
                            </a>
                        </li>
                    </ul>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Reportes Guardados</span>
                        <a class="link-secondary" href="#" aria-label="Add a new report">
                            <span data-feather="plus-circle"></span>
                        </a>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file-text"></span>
                                Reporte Mensual
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            {# Columna del Contenido Principal (70%) #}
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="main-content-title">Bienvenido a tu Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        {# Botones o acciones del dashboard #}
                    </div>
                </div>

                {# Aquí es donde se cargará el contenido dinámico #}
                <div id="dynamic-content">
                    <p>Selecciona un elemento del menú de la izquierda para ver su contenido.</p>
                    {# Este es el contenido por defecto del dashboard #}
                </div>
            </main>
        </div>
    </div>

    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dynamicContentDiv = document.getElementById('dynamic-content');
        const mainContentTitle = document.getElementById('main-content-title');

        function loadContent(url, title) {
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Añade esta cabecera para que Django detecte la petición AJAX
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // Limpia el contenido actual y lo reemplaza con el HTML cargado
                dynamicContentDiv.innerHTML = html;
                mainContentTitle.innerText = title;

                // Después de inyectar el HTML, buscar y ejecutar cualquier script inyectado.
                // Esta es la parte crucial para que los gráficos funcionen.
                const scripts = dynamicContentDiv.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    // Eliminar el script viejo antes de añadir el nuevo para evitar duplicados
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    dynamicContentDiv.appendChild(newScript);
                });


                // Después de cargar el contenido, si hay botones de reporte, inicialízalos.
                // Esta función se necesita si el contenido inyectado incluye esos botones.
                initializeReportCardClicks();

            })
            .catch(error => {
                console.error('Error al cargar el contenido:', error);
                dynamicContentDiv.innerHTML = '<div class="alert alert-danger" role="alert">Error al cargar el contenido. Por favor, inténtalo de nuevo.</div>';
            });
        }

        function initializeReportCardClicks() {
            // console.log("Inicializando clics de tarjetas de reportes."); // Para depuración
            const reportButtons = dynamicContentDiv.querySelectorAll('.btn[data-report-type]');

            // console.log("Botones de reporte encontrados:", reportButtons.length); // Para depuración

            reportButtons.forEach(button => {
                // Siempre elimina y re-adjunta el listener para evitar duplicados
                const oldButton = button;
                const newButton = oldButton.cloneNode(true);
                oldButton.parentNode.replaceChild(newButton, oldButton);

                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const reportType = this.dataset.reportType;
                    // console.log("Botón de tarjeta clicado, tipo:", reportType);

                    if (reportType === 'promedio_historico') {
                        window.location.href = '/account/reportes/promedio_historico/';
                    } else if (reportType === 'egresados') {
                        window.location.href = '/account/reportes/egresados/';
                    } else if (reportType === 'examenes') {
                        window.location.href = '/account/reportes/examenes/';
                    } else if (reportType === 'cursadas') {
                        window.location.href = '/account/reportes/cursadas/';
                    } else if (reportType === 'ingresantes') {
                        window.location.href = '/account/estadisticas/ingresantes/';
                    } else if (reportType === 'retenidos') {
                        window.location.href = '/account/estadisticas/retenidos/';
                    } else if (reportType === 'etarios') {
                        window.location.href = '/account/estadisticas/etarios/';
                    } else if (reportType === 'gradxanio') {
                        window.location.href = '/account/estadisticas/egresados/';
                    } else if (reportType === 'docentes') {
                        window.location.href = '/account/estadisticas/docentes/';
                    } else if (reportType === 'resultado_cursada') {
                        window.location.href = '/account/reportes/resultado_cursada/';
                    } else {
                        console.warn('Tipo de reporte no reconocido:', reportType);
                    }
                });
            });
        }

        document.getElementById('reportes-link').addEventListener('click', function(e) {
            e.preventDefault();
            loadContent('/account/reportes/', 'Reportes UTN-FRCU');
        });

        document.getElementById('estadisticas-link').addEventListener('click', function(e) {
            e.preventDefault();
            loadContent('/account/estadisticas/', 'Estadísticas del Sistema');
        });

        document.getElementById('dashboard-link').addEventListener('click', function(e) {
            e.preventDefault();
            loadContent('/account/inicio/', 'Inicio'); // Carga el contenido de inicio.html
        });

        // Opcional: Cargar el dashboard (inicio) por defecto al cargar la página
        loadContent('/account/inicio/', 'Inicio');

    });
</script>
{% endblock %}